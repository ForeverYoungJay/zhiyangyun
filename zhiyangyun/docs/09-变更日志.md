# 变更日志

> 记录规则：遵循 Keep a Changelog 风格（Added / Changed / Fixed / Docs）。

## 模板（可复用）

```md
## YYYY-MM-DD
### Added
- 

### Changed
- 

### Fixed
- 

### Docs
- 

### Notes
- 风险：
- 回滚方案：
```

---

## 2026-02-24
### Added
- B1 小程序服务流补齐状态流转接口：`POST /b1-miniapp/requests/{id}/status`，并在流转时写入通知消息。
- B2 新增家属互动通知查询：`GET /b2-family/notifications`。

### Changed
- B1/B2/B3 列表接口统一支持分页参数（`page/page_size`）与关键字/状态/日期筛选。
- B1/B2 列表结果补齐姓名化字段（如 `elder_name/elder_no`），前端页面改为姓名展示。
- B3 经营看板汇总新增“手工补录指标联动”（补录营收/占用率/告警可回流 summary）。
- 前端 B1/B2/B3 页面统一补齐分页、搜索、筛选交互。
- 回归脚本新增 B1/B2/B3 专项断言：分页结构、姓名化字段、通知可见性、看板联动字段。

### Fixed
- 修复 `scripts/api_regression.py` 对中文 query 未编码导致的 `'ascii' codec can't encode characters` 异常。
- 修复回归脚本对分页返回结构的兼容性问题（同时支持 `{items,total}` 与列表结果）。
- 修复部分断言的稳健性（列表取值与发票流程前置判定），避免误报失败。

### Changed
- 回归脚本新增 `--strict` 模式：严格校验 404 与断言失败；默认模式对 404 记兼容跳过以提升复用性。
- OA1 模板创建新增业务规则：时间合法性校验与同名同时间模板去重。
- OA1 排班创建新增业务规则：禁止过去日期、同人同日冲突班次拦截。
- OA1 排班列表查询新增 `start_date/end_date` 筛选参数。
- OA1 排班结果新增 `display_name`，前端改为姓名化展示。

### Added
- OA1 发布动作自动联动 OA2：创建 `module=oa1_shift` 审批待办。
- 回归脚本补充 OA1 校验点：冲突检测、审批联动、日期区间筛选、姓名化字段。

### Docs
- 重写 `docs/08-测试与验收手册.md`：补充执行模式、判定标准、手工验收顺序、可复用验收模板。
- 新增本文件“变更日志模板”，统一后续记录格式。
- 更新 `docs/04-API清单.md` OA1 参数与业务规则说明。

## 2026-02-16
### Added
- M7 新增收费业务流接口：发票生成、核销、异常处理、事件流水查询
- M7 新增 `billing_events` 审计表，记录状态流转与金额操作
- API 回归脚本新增 M7 关键流程校验（分页、姓名化、生成、核销、异常、事件）

### Changed
- M7 列表接口升级为分页/搜索/筛选，并返回 `elder_name/elder_no`
- M7 前端升级为业务化页面：账单与发票双列表、核销与异常处理操作、事件追踪
- README 与 API/测试文档同步更新，补充 M7 收费闭环说明

## 2026-02-15
### Added
- M6 新增长者自动联想接口：`GET /m6-health/elders/suggest`
- M6 新增评估闭环接口：`POST /m6-health/assessments/{id}/close`
- M6 前端升级为双列表（体征/评估）分页检索，姓名展示替代纯 ID
- API 回归脚本补充 M6 分页、异常规则、闭环校验点

### Changed
- `POST /m6-health/vitals` 增加生命体征异常规则（normal/warning/critical）与异常原因沉淀
- 体征异常自动联动：创建 M3 健康随访任务 + OA3 告警 + OA2 审批待办
- `POST /m6-health/assessments` 增加高风险自动随访任务，形成评估闭环链路

## 2026-02-13
### Added
- M4 新增长者自动联想接口：`GET /m4-medication/elders/suggest`
- M4 前端支持长者姓名展示、分页检索、一键执行
- M5 新增长者自动联想接口：`GET /m5-meal/elders/suggest`
- M5 前端新增“方案列表 + 下发记录”双列表分页与姓名化展示
- API 回归脚本补充 M4/M5 分页、联想、自动计费校验点

### Changed
- M4 订单列表接口支持分页+关键字+状态筛选，并返回 `elder_name/elder_no`
- M4 用药执行成功后自动写入 M7 账单条目，并累计当月发票金额
- M5 方案/订单列表接口支持分页+关键字筛选，订单返回 `elder_name/plan_name`
- M5 下发成功后自动写入 M7 “膳食供应”账单条目，并累计当月发票金额

## 2026-02-11
### Added
- B2 家属门户新增：
  - `GET /b2-family/elders/{elder_id}/overview`
  - `GET /b2-family/services/catalog`
  - `POST /b2-family/services/order`
- B2 前端新增“长者总览”“服务增购”入口
- API 回归脚本新增 family overview/catalog/order 校验
- M1 资产新增入住率汇总接口：`GET /assets/occupancy-summary`
- M1 资产新增床位状态对账修复：`POST /assets/beds/reconcile`
- M1 前端新增床位运营卡片、异常提示和一键修复入口
- M2 新增全周期概览接口：`GET /elders/overview/summary`
- M2 新增床位联动巡检接口：`GET /elders/audit/bed-sync`
- M2 前端新增经营概览卡片与“同步巡检”入口
- M3 新增治理概览接口：`GET /care/governance-summary`（待执行/逾期/自动扣费等）
- M3 前端新增治理KPI卡片，便于班次排班与异常处置
- API 回归脚本新增 M1 occupancy/reconcile、M2 overview/audit、M3 governance summary 校验
- 新建 docs 文档体系（架构、模型、API、时序、权限、部署、测试、审计）

### Changed
- README 补充文档索引、回归说明与新增接口

### Known Issues
- RBAC 细粒度控制未落地
- 微信专属链路（wx-login、支付回调）尚未接入
