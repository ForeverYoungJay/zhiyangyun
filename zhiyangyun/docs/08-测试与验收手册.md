# 测试与验收手册

## 1. 目标
用于统一执行 API 回归、记录验收结论、沉淀可复用测试流程。

## 2. 自动回归（API）

### 2.1 执行命令
```bash
# 默认：兼容模式（对 404 接口记为 SKIP，通过其它链路继续验证）
python3 scripts/api_regression.py

# 严格模式：任何 404/断言失败均返回非 0
python3 scripts/api_regression.py --strict

# 指定网关
python3 scripts/api_regression.py http://localhost:8000/api/v1
```

### 2.2 覆盖范围
- 鉴权与基础资源：Auth、资产、长者档案
- 核心业务：护理、用药、膳食、健康、收费、排班、审批通知
- OA1 专项：模板规则校验、同日冲突检测、发布审批联动、日期区间筛选、姓名化字段
- OA2 专项：审批状态机（多级 approve）、抄送名单、审批轨迹
- OA3 专项：触达策略（immediate/queued）、范围筛选（all/single）、送达/重试/失败状态机动作
- OA4 专项：培训计划分页、记录分页筛选（含 course_id）、签到后考核闭环、闭环统计
- 家属端联动：B2 总览、服务、账单、记录
- 商城与库存：商品、库存流水、订单、账户流水
- 跨模块校验：通过 `CHK` 项断言（自动计费、状态流转、闭环链路等）

### 2.3 结果判定
- 终端输出：`API回归结果: total=... pass=... fail=...`
- 判定规则：
  - `fail=0`：通过
  - `fail>0`：不通过（CI 应阻断）
- 建议：发布前至少执行一次 `--strict`

## 3. 手工验收流程（建议顺序）
1. 登录并创建长者，完成入院。
2. 配置服务包，生成护理任务并完成扫码闭环。
3. 执行用药/膳食，确认自动计费落账。
4. 在 M7 完成发票核销、异常流转、事件追踪。
5. 在 OA1 完成排班发布→执行→重开。
6. 在 B2 核对家属可见账单、护理记录与商城订单。

## 4. 验收记录模板（可复用）

```md
# 验收记录 - <版本号/日期>

## 一、环境信息
- API Base: <http://.../api/v1>
- 数据库/租户: <...>
- 提交号: <git sha>
- 执行人: <name>
- 执行时间: <yyyy-mm-dd hh:mm>

## 二、自动回归
- 命令: `python3 scripts/api_regression.py --strict`
- 结果: total=<N>, pass=<N>, fail=<N>
- 日志位置: <path or CI url>

## 三、手工验收结论
- [ ] 入院与床位联动
- [ ] 护理任务闭环
- [ ] 用药/膳食自动计费
- [ ] 发票核销与异常流转
- [ ] 排班状态流转
- [ ] 家属端可见性（账单/记录/订单）

## 四、问题清单
| 编号 | 现象 | 影响 | 优先级 | 责任人 | 状态 |
|---|---|---|---|---|---|
| BUG-001 |  |  | P1/P2/P3 |  | Open/Fixed |

## 五、发布建议
- 是否允许发布：<是/否>
- 附加条件：<...>
```

## 5. 回归脚本维护约束
- 不修改业务规则，仅修正测试脚本兼容性与断言准确性。
- 新增功能时：
  1) 先补 API 断言（`CHK`）
  2) 再补本文档“覆盖范围”和“手工验收项”
  3) 最后补 `docs/09-变更日志.md`
