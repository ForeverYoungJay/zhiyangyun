# 功能遗漏审计（对照《技术文档.md》+《构思想法.docx》）

> 评估时间：2026-02-11
> 评级：A1=高优先（主链路缺口）；A2=中优先（运营效率/治理）；B=规划项（需专项建设）

## 一、A1（高优先）

### 1) 家属端“长者总览 + 服务增购”入口缺失（已修复）
- 需求源：
  - 技术文档 4.4/7.1：家属端需有长者总览、服务增购。
  - 构思想法：家属侧应查看档案/健康/服务并可在线增购。
- 现状（修复前）：B2 仅有账单、护理记录、问卷。
- 修复：
  - 新增 `GET /api/v1/b2-family/elders/{elder_id}/overview`
  - 新增 `GET /api/v1/b2-family/services/catalog`
  - 新增 `POST /api/v1/b2-family/services/order`
  - 前端 B2 页面新增“长者总览”“服务增购”页签。

### 2) 双端 API 目录与实现不一致（部分修复）
- 需求源：技术文档 7.1 全量 API 清单。
- 现状：项目已覆盖大多数主链路，但仍非 1:1 对齐（如 family chat、workflow 细颗粒动作、wx 登录链）。
- 本轮处理：补充家属端关键缺口；其余列入下轮 A1/A2。

## 二、A2（中优先）

### 1) 权限隔离落地不足
- 需求源：技术文档第 11 章（RBAC + 数据范围）。
- 现状：后端已有 role/permission 表，但运行时鉴权仍以“登录即通过”为主。
- 影响：跨角色访问控制与审计颗粒度不足。
- 建议：
  1. token 注入 role；
  2. 增加路由级权限装饰器；
  3. 增加 data-scope 过滤。

### 2) 审计与链路追踪能力未成体系
- 需求源：第 12/15 章（审计日志、trace_id、可观测）。
- 现状：接口有统一响应，但缺审计中间件、trace 贯穿、落库策略。

### 3) 工作流引擎仍为轻量实现
- 需求源：第 6.7 / 7.1 / 13 章（审批定义、节点流转、会签/转办）。
- 现状：OA2 具备基础审批记录；复杂流程能力待补。

## 三、B（规划项）

1. 物联网能力：手环、门禁、电子围栏、SOS。  
2. AI 决策：营销转化预测、护理排班优化、财务预测。  
3. 外部系统对接：长护险、医保、政府监管。  
4. 小程序专属链路：`wx-login`、支付回调、订阅消息。

## 四、本轮修复清单（代码级）

- 后端：
  - `backend/app/api/routes/b2_family.py`
  - `backend/app/services/business_service.py`
  - `backend/app/schemas/business.py`
- 前端：
  - `web/src/pages/modules/B2FamilyPage.vue`
- 回归：
  - `scripts/api_regression.py` 新增 family overview/catalog/order 校验。

## 五、未修复项与优先顺序

1. **A1**：补齐 family health/detail、activities、chat（接口+页面）。  
2. **A2**：RBAC 与 data-scope 真正生效。  
3. **A2**：审计日志中间件与 trace_id 全链路。  
4. **B**：IoT 与外部平台对接。  
